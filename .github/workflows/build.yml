name: Build Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-rust-backend:
    name: Build Rust Backend
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: ech-workers-rs.exe
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: ech-workers-rs
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ech-workers-rs/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('ech-workers-rs/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Download WinTun (Windows only)
        if: matrix.os == 'windows-latest'
        run: |
          $wintunVersion = "0.14.1"
          $wintunUrl = "https://www.wintun.net/builds/wintun-$wintunVersion.zip"
          Invoke-WebRequest -Uri $wintunUrl -OutFile wintun.zip
          Expand-Archive -Path wintun.zip -DestinationPath wintun-temp
          Copy-Item wintun-temp\wintun\bin\amd64\wintun.dll ech-workers-rs\target\release\wintun.dll
          Remove-Item wintun.zip, wintun-temp -Recurse -Force
        shell: pwsh
      
      - name: Build Backend
        run: |
          cd ech-workers-rs
          cargo build --release --locked
        env:
          RUSTFLAGS: "-C opt-level=3 -C lto=fat -C codegen-units=1 -C strip=symbols"
      
      - name: Verify WinTun (Windows only)
        if: matrix.os == 'windows-latest'
        run: |
          if not exist ech-workers-rs\target\release\wintun.dll exit 1
          dir ech-workers-rs\target\release\wintun.dll
      
      - name: Package Windows Artifacts
        if: matrix.os == 'windows-latest'
        run: |
          mkdir backend-package
          copy ech-workers-rs\target\release\ech-workers-rs.exe backend-package\
          copy ech-workers-rs\target\release\wintun.dll backend-package\
      
      - name: Package Linux Artifacts
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p backend-package
          cp ech-workers-rs/target/release/ech-workers-rs backend-package/
      
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.os }}
          path: backend-package/*
          compression-level: 9

  build-qt-gui-windows:
    name: Build Qt GUI (Windows)
    runs-on: windows-latest
    needs: build-rust-backend
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.7.0'
          arch: 'win64_msvc2019_64'
          modules: 'qtbase'
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Setup Ninja
        run: choco install ninja -y
      
      - name: Download Backend
        uses: actions/download-artifact@v4
        with:
          name: backend-windows-latest
          path: qt-gui/backend
      
      - name: List Backend Files
        run: dir qt-gui\backend
      
      - name: Cache CMake Build
        uses: actions/cache@v4
        with:
          path: qt-gui/build
          key: ${{ runner.os }}-cmake-${{ hashFiles('qt-gui/CMakeLists.txt', 'qt-gui/src/**', 'qt-gui/include/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-
      
      - name: Build Qt GUI
        run: |
          cd qt-gui
          mkdir build
          cd build
          cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS_RELEASE="/O2 /DNDEBUG /GL" -DCMAKE_EXE_LINKER_FLAGS_RELEASE="/LTCG /OPT:REF /OPT:ICF"
          cmake --build . --config Release
      
      - name: Deploy Qt
        run: |
          cd qt-gui/build
          windeployqt Release/ech-workers-gui.exe --release --no-compiler-runtime --no-translations
          copy ..\backend\ech-workers-rs.exe Release\ || exit 1
          copy ..\backend\wintun.dll Release\ || exit 1
      
      - name: Verify Build
        run: |
          cd qt-gui/build/Release
          if not exist ech-workers-gui.exe exit 1
          if not exist ech-workers-rs.exe exit 1
          if not exist wintun.dll exit 1
          dir ech-workers-gui.exe
          dir ech-workers-rs.exe
          dir wintun.dll
      
      - name: Create Package
        run: |
          cd qt-gui/build/Release
          7z a ../../../ech-workers-gui-windows-x64.zip *
      
      - name: Upload GUI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gui-windows
          path: ech-workers-gui-windows-x64.zip
          compression-level: 0

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-rust-backend, build-qt-gui-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      
      - name: List Downloaded Artifacts
        run: |
          echo "=== Artifact Structure ==="
          ls -R
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ech-workers-rs.exe
            wintun.dll
            ech-workers-rs
            ech-workers-gui-windows-x64.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
